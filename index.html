<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SEMARANG REGIONAL MUN 2025 UNESCO</title>
  <script src="https://cdn.tailwindcss.com"></script>  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

  <header class="bg-red-700 text-white p-6 text-center shadow-md">
    <h1 class="text-3xl font-semibold">Semarang Regional MUN 2025 UNESCO</h1>
  </header>

  <main class="container mx-auto px-4 py-6 flex-1 flex flex-col">

    <!-- FORM SECTION -->
    <section class="bg-white rounded shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">Add / Update Delegate Grading</h2>

      <form id="delegateForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
        <div>
          <label for="countryInput" class="block mb-1 font-medium text-gray-700">Country</label>
          <input type="text" id="countryInput" required placeholder="Delegate Country" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-red-400" />
        </div>

        <div>
          <label for="gslInput" class="block mb-1 font-medium text-gray-700">GSL Points (0-20)</label>
          <input type="number" id="gslInput" min="0" max="20" value="0" required class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>

        <div>
          <label for="modInput" class="block mb-1 font-medium text-gray-700">Mod Caucus (0-10)</label>
          <input type="number" id="modInput" min="0" max="10" value="0" required class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>

        <div>
          <label for="poiInput" class="block mb-1 font-medium text-gray-700">POI (0-5)</label>
          <input type="number" id="poiInput" min="0" max="5" value="0" required class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>

        <div>
          <label for="poireplyInput" class="block mb-1 font-medium text-gray-700">POI Reply (0-5)</label>
          <input type="number" id="poireplyInput" min="0" max="5" value="0" required class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>

        <div>
          <label for="documentationInput" class="block mb-1 font-medium text-gray-700">Documentation (0-10)</label>
          <input type="number" id="documentationInput" min="0" max="10" value="0" required class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>

        <div>
          <label for="lobbyingInput" class="block mb-1 font-medium text-gray-700">Lobbying (0-5)</label>
          <input type="number" id="lobbyingInput" min="0" max="5" value="0" required class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>

        <div>
          <label for="decorumInput" class="block mb-1 font-medium text-gray-700">Decorum (0-5)</label>
          <input type="number" id="decorumInput" min="0" max="5" value="0" required class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>

        <!-- Comments -->
        <div class="md:col-span-4">
          <label for="commentInput" class="block mb-1 font-medium text-gray-700">Comments</label>
          <textarea id="commentInput" placeholder="Feedback or comments about this delegate..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-red-400" rows="3"></textarea>
        </div>

        <div class="md:col-span-4 text-right mt-4">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded px-6 py-3 transition">Save Delegate</button>
        </div>
      </form>
    </section>

    <!-- TABLE SECTION -->
    <section class="bg-white rounded shadow p-6 flex-grow overflow-auto">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">Delegates Grading Overview</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-300 rounded text-left text-sm">
          <thead class="bg-red-600 text-white">
            <tr>
              <th class="px-3 py-2 border border-red-700">#</th>
              <th class="px-3 py-2 border border-red-700">Country</th>
              <th class="px-3 py-2 border border-red-700">GSL (20)</th>
              <th class="px-3 py-2 border border-red-700">Mod (10)</th>
              <th class="px-3 py-2 border border-red-700">POI (5)</th>
              <th class="px-3 py-2 border border-red-700">POI Reply (5)</th>
              <th class="px-3 py-2 border border-red-700">Docs (10)</th>
              <th class="px-3 py-2 border border-red-700">Lobby (5)</th>
              <th class="px-3 py-2 border border-red-700">Decorum (5)</th>
              <th class="px-3 py-2 border border-red-700">Total</th>
              <th class="px-3 py-2 border border-red-700">Comments</th>
              <th class="px-3 py-2 border border-red-700">Actions</th>
            </tr>
          </thead>
          <tbody id="delegatesTableBody" class="bg-white"></tbody>
        </table>
      </div>
      <p class="mt-2 text-gray-600 text-sm">* Comments also appear in the downloaded PDF.</p>
    </section>
  </main>

  <footer class="bg-red-700 text-white text-center py-4 mt-auto shadow-inner">
    &copy; 2024 MUN Grading System
  </footer>

  <script>
    // Utility
    function clampValue(val, min, max) {
      let n = parseInt(val);
      if (isNaN(n)) return 0;
      return Math.min(Math.max(n, min), max);
    }

    const form = document.getElementById('delegateForm');
    const tableBody = document.getElementById('delegatesTableBody');
    const countryInput = document.getElementById('countryInput');
    const gslInput = document.getElementById('gslInput');
    const modInput = document.getElementById('modInput');
    const poiInput = document.getElementById('poiInput');
    const poireplyInput = document.getElementById('poireplyInput');
    const documentationInput = document.getElementById('documentationInput');
    const lobbyingInput = document.getElementById('lobbyingInput');
    const decorumInput = document.getElementById('decorumInput');
    const commentInput = document.getElementById('commentInput');

    function getDelegates() {
      return JSON.parse(localStorage.getItem('mun_delegates') || '[]');
    }
    function saveDelegates(delegates) {
      localStorage.setItem('mun_delegates', JSON.stringify(delegates));
    }
    function calculateTotal(d) {
      return d.gsl + d.mod + d.poi + d.poireply + d.documentation + d.lobbying + d.decorum;
    }

    function escapeHtml(text) {
      return text ? text.replace(/[\"&'\/<>]/g, a => ({'"':'&quot;','&':'&amp;',"'":'&#39;','/':'&#47;','<':'&lt;','>':'&gt;'}[a])) : '';
    }

    function renderDelegates() {
      const delegates = getDelegates();
      tableBody.innerHTML = '';
      if (delegates.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="12" class="text-center text-gray-500 py-4">No delegates added yet.</td></tr>';
        return;
      }

      delegates.forEach((d, i) => {
        const total = calculateTotal(d);
        const row = document.createElement('tr');
        row.classList.add(i % 2 === 0 ? 'bg-gray-50' : 'bg-white');
        row.innerHTML = `
          <td class="border text-center px-2 py-1">${i + 1}</td>
          <td class="border px-3 py-1 font-semibold">${escapeHtml(d.country)}</td>
          <td class="border text-center">${d.gsl}</td>
          <td class="border text-center">${d.mod}</td>
          <td class="border text-center">${d.poi}</td>
          <td class="border text-center">${d.poireply}</td>
          <td class="border text-center">${d.documentation}</td>
          <td class="border text-center">${d.lobbying}</td>
          <td class="border text-center">${d.decorum}</td>
          <td class="border text-center font-semibold">${total}</td>
          <td class="border px-2 py-1 text-sm">${escapeHtml(d.comment || '')}</td>
          <td class="border text-center space-x-1">
            <button data-country="${escapeHtml(d.country)}" class="edit bg-blue-600 hover:bg-blue-700 text-white rounded px-3 py-1 text-xs">Edit</button>
            <button data-country="${escapeHtml(d.country)}" class="delete bg-red-600 hover:bg-red-700 text-white rounded px-3 py-1 text-xs">Delete</button>
            <button data-country="${escapeHtml(d.country)}" class="pdf bg-green-600 hover:bg-green-700 text-white rounded px-3 py-1 text-xs">PDF</button>
          </td>`;
        tableBody.appendChild(row);
      });

      document.querySelectorAll('.edit').forEach(btn => btn.addEventListener('click', e => loadDelegateForEdit(e.target.dataset.country)));
      document.querySelectorAll('.delete').forEach(btn => btn.addEventListener('click', e => deleteDelegate(e.target.dataset.country)));
      document.querySelectorAll('.pdf').forEach(btn => btn.addEventListener('click', e => generatePDF(e.target.dataset.country)));
    }

    function loadDelegateForEdit(country) {
      const delegates = getDelegates();
      const d = delegates.find(x => x.country.toLowerCase() === country.toLowerCase());
      if (!d) return alert('Delegate not found.');
      countryInput.value = d.country;
      gslInput.value = d.gsl;
      modInput.value = d.mod;
      poiInput.value = d.poi;
      poireplyInput.value = d.poireply;
      documentationInput.value = d.documentation;
      lobbyingInput.value = d.lobbying;
      decorumInput.value = d.decorum;
      commentInput.value = d.comment || '';
    }

    function deleteDelegate(country) {
      if (!confirm(`Delete delegate "${country}"?`)) return;
      const delegates = getDelegates().filter(d => d.country.toLowerCase() !== country.toLowerCase());
      saveDelegates(delegates);
      renderDelegates();
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const country = countryInput.value.trim();
      if (!country) return alert('Country cannot be empty.');
      const gsl = clampValue(gslInput.value, 0, 20);
      const mod = clampValue(modInput.value, 0, 10);
      const poi = clampValue(poiInput.value, 0, 5);
      const poireply = clampValue(poireplyInput.value, 0, 5);
      const documentation = clampValue(documentationInput.value, 0, 10);
      const lobbying = clampValue(lobbyingInput.value, 0, 5);
      const decorum = clampValue(decorumInput.value, 0, 5);
      const comment = commentInput.value.trim();

      const delegates = getDelegates();
      const idx = delegates.findIndex(d => d.country.toLowerCase() === country.toLowerCase());
      const newData = { country, gsl, mod, poi, poireply, documentation, lobbying, decorum, comment };

      if (idx >= 0) delegates[idx] = newData;
      else delegates.push(newData);
      saveDelegates(delegates);
      form.reset();
      renderDelegates();
    });

    // 🧾 Generate Neat PDF
    async function generatePDF(country) {
      const { jsPDF } = window.jspdf;
      const delegates = getDelegates();
      const d = delegates.find(x => x.country.toLowerCase() === country.toLowerCase());
      if (!d) return alert('Delegate not found.');

      const doc = new jsPDF();
      doc.setFontSize(20);
      doc.setTextColor(102, 0, 51);
      doc.text("UNESCO SEMARANG REGIONAL MUN 2025", 105, 20, null, null, "center");

      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text(`Delegate Country: ${d.country}`, 20, 35);

      doc.setDrawColor(150, 0, 0);
      doc.line(20, 40, 190, 40);

      const startY = 50;
      const rowHeight = 10;
      const criteria = [
        ["GSL Points", 20, d.gsl],
        ["Moderated Caucus", 10, d.mod],
        ["Points of Information", 5, d.poi],
        ["POI Reply", 5, d.poireply],
        ["Documentation", 10, d.documentation],
        ["Lobbying", 5, d.lobbying],
        ["Decorum", 5, d.decorum]
      ];

      doc.setFillColor(102, 0, 51);
      doc.setTextColor(255, 255, 255);
      doc.rect(20, startY - 8, 170, 10, "F");
      doc.text("Criteria", 25, startY - 1);
      doc.text("Max Points", 115, startY - 1);
      doc.text("Awarded", 160, startY - 1);

      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      criteria.forEach((c, i) => {
        const y = startY + i * rowHeight;
        doc.text(c[0], 25, y);
        doc.text(c[1].toString(), 125, y, null, null, "right");
        doc.text(c[2].toString(), 175, y, null, null, "right");
      });

      const total = calculateTotal(d);
      const totalY = startY + (criteria.length + 1) * rowHeight;
      doc.setFontSize(14);
      doc.setTextColor(102, 0, 51);
      doc.text("TOTAL SCORE", 25, totalY);
      doc.text(`${total}`, 175, totalY, null, null, "right");
      doc.line(20, totalY + 2, 190, totalY + 2);

      // Comments
      if (d.comment && d.comment.trim() !== "") {
        const commentY = totalY + 12;
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(13);
        doc.text("Judge’s Comments:", 20, commentY);
        doc.setFontSize(11);
        const wrapped = doc.splitTextToSize(d.comment.trim(), 160);
        doc.text(wrapped, 25, commentY + 8);
      }

      // Footer
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text("Generated by MUN Grading System", 105, 285, null, null, "center");

      doc.save(`MUN_Grading_${d.country.replace(/\s+/g, '_')}.pdf`);
    }

    renderDelegates();
  </script>
</body>
</html>
